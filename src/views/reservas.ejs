<!-- src/views/reservas.ejs -->
<link rel="shortcut icon" href="https://ajeetchaulagain.com/static/7cb4af597964b0911fe71cb2f8148d64/87351/express-js.png" type="image/x-icon" />
<%- include('./layouts/nav') %>
<h1>Gestión de Reservas</h1>

<!-- Formulario para agregar una nueva reserva -->
<form id="formularioAgregarReserva" action="/agregarReserva" method="POST">
  <label for="fechaReserva">Fecha de Reserva:</label>
  <input type="date" id="fechaReserva" name="fechaReserva" required>

  <label for="estadoReserva">Estado de Reserva:</label>
  <select id="estadoReserva" name="estadoReserva" required>
    <option value="Agendada">Agendada</option>
    <option value="Rechazada">Rechazada</option>
    <option value="Terminada">Terminada</option>
  </select>

  <label for="nombreCliente">Nombre del Cliente:</label>
  <select id="nombreCliente" name="nombreCliente" onchange="obtenerConfiguracionCliente()" required>
    <% configuraciones.forEach(configuracion => { %>
      <option value="<%= configuracion.nombre %>">
        <%= configuracion.nombre %>
      </option>
    <% }); %>
  </select>

  <label for="telefonoCliente">Telefono:</label>
  <input type="text" id="telefonoCliente" name="telefonoCliente" required>

  <!-- Otros campos que ingreses manualmente -->

  <button type="submit">Guardar Cambios</button>
</form>

<!-- Lista de reservas existentes -->
<h2>Listado de Reservas</h2>
<table>
  <thead>
    <tr>
      <td>Fecha de Creación</td>
      <td>Fecha de Reserva</td>
      <td>Estado de Reserva</td>
      <td>Nombre del Cliente</td>
      <td>Correo del Cliente</td>
      <td>Telefono Del Cliente</td>
      <td>Documento del Cliente</td>
      <td>Contraseña del Cliente</td>
      <!-- Otros campos que ingreses manualmente -->
      <td>Acción</td>
    </tr>
  </thead>
  <tbody>
    <% reservas.forEach(reserva => { %>
      <tr>
        <td><%= new Date(reserva.fecha_creacion).toLocaleDateString('es-ES') %></td>
        <td><%= new Date(reserva.fecha_reserva).toLocaleDateString('es-ES') %></td>
        <td><%= reserva.estado_reserva %></td>
        <td><%= reserva.nombre_cliente %></td>
        <td><%= reserva.correo || reserva.email %></td>
        <td><%= reserva.telefono_cliente %></td>
        <td><%= reserva.documento_cliente %></td>
        <td><%= reserva.contraseña %></td>
        <!-- Otros campos que ingreses manualmente -->
        <td>
          &nbsp; 
          <form id="eliminarReservaForm" onsubmit="eliminarReserva(event, '<%= reserva._id %>')">
            <input type="hidden" name="_method" value="DELETE">
            <button onclick="eliminarReserva(event, '<%= reserva._id %>')">Eliminar</button>
          </form>
        </td>
        <td>
          <button onclick="abrirEdicionReserva('<%= reserva._id %>')">Editar</button>
        </td>
      </tr>
    <% }); %>
  </tbody>
</table>

<!-- Sección de Edición -->
<div id="edicionReserva" style="display:none;">
  <h2>Edición de Reserva</h2>
  <form id="formularioEdicionReserva" action="/actualizarReserva" method="POST" onsubmit="actualizarReservaDesdeEdicion(event)">
    <input type="hidden" id="reservaIdEdicion" name="reservaIdEdicion">
    <label for="fechaReservaEdicion">Fecha de Reserva:</label>
    <input type="date" id="fechaReservaEdicion" name="fechaReservaEdicion" required>

    <label for="estadoReservaEdicion">Estado de Reserva:</label>
    <select id="estadoReservaEdicion" name="estadoReservaEdicion" required>
      <option value="Agendada">Agendada</option>
      <option value="Rechazada">Rechazada</option>
      <option value="Terminada">Terminada</option>
    </select>

    <button type="submit">Guardar Cambios</button>
    <button type="button" onclick="cerrarEdicionReserva()">Cancelar</button>
  </form>
</div>

<script>
  function obtenerConfiguracionCliente() {
    var selectedIndex = document.getElementById('nombreCliente').selectedIndex;
    var configuracionCliente = configuraciones[selectedIndex] || {};
    document.getElementById('correoCliente').value = configuracionCliente.correo || '';
    document.getElementById('contrasenaCliente').value = configuracionCliente.contrasena || '';
    document.getElementById('documentoCliente').value = configuracionCliente.documento || '';
  }

  async function eliminarReserva(event, reservaId) {
    event.preventDefault();
    const confirmacion = confirm('¿Estás seguro de eliminar esta reserva?');
    if (confirmacion) {
      const options = {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      };

      try {
        const response = await fetch(`/eliminarReserva/${reservaId}`, options);
        if (response.ok) {
          // Eliminar la fila del DOM
          const rowToRemove = document.querySelector(`tr[data-id="${reservaId}"]`);
          rowToRemove.remove();

          // Eliminar la reserva del arreglo
          const reservaIndex = reservas.findIndex(reserva => reserva._id === reservaId);
          if (reservaIndex !== -1) {
            reservas.splice(reservaIndex, 1);
          }
        } else {
          console.error('Error al eliminar la reserva');
        }
      } catch (error) {
        console.error('Error de red:', error);
      }
    }
  }

  function abrirEdicionReserva(id) {
  fetch(`/obtenerDetallesReserva/${id}`)
    .then(response => response.json())
    .then(reserva => {
      document.getElementById('reservaIdEdicion').value = reserva._id;
      document.getElementById('fechaReservaEdicion').value = reserva.fecha_reserva;
      document.getElementById('estadoReservaEdicion').value = reserva.estado_reserva;

      // Mostrar la sección de edición
      document.getElementById('edicionReserva').style.display = 'block';
    })
    .catch(error => console.error('Error al obtener detalles de la reserva:', error));
}

  function cerrarEdicionReserva() {
    // Ocultar la sección de edición
    document.getElementById('edicionReserva').style.display = 'none';
  }

  async function actualizarReservaDesdeEdicion(event) {
    console.log('Submit del formulario de edición');
  event.preventDefault();

  const reservaId = document.getElementById('reservaIdEdicion').value;
  const fechaReserva = document.getElementById('fechaReservaEdicion').value;
  const estadoReserva = document.getElementById('estadoReservaEdicion').value;
  const telefonoCliente = document.getElementById('telefonoClienteEdicion').value;
  const documentoCliente = document.getElementById('documentoClienteEdicion').value; // Agrega otros campos según sea necesario
  const contraseñaCliente = document.getElementById('contraseñaClienteEdicion').value;
  const correoCliente = document.getElementById('correoClienteEdicion').value;

  console.log('Datos a enviar:', {
    reservaId,
    fechaReserva,
    estadoReserva,
    telefonoCliente,
    documentoCliente,
    contraseñaCliente,
    correoCliente,
  });

  const options = {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      fechaReserva,
      estadoReserva,
      telefonoCliente,
      documentoCliente,
      contraseñaCliente,
      correoCliente,
    }),
  };

  try {
    const response = await fetch(`/actualizarReserva/${reservaId}`, options);
    if (response.ok) {
      console.log('Reserva actualizada con éxito:', await response.json());
    } else {
      console.error('Error al actualizar la reserva:', response.statusText);
    }
  } catch (error) {
    console.error('Error de red:', error);
  }
  return false;
}



function actualizarFilaEnDOM(reservaId, updatedReserva) {
  // Encuentra la fila correspondiente y actualiza sus celdas
  const fila = document.querySelector(`tr[data-id="${reservaId}"]`);
  fila.querySelector('td:nth-child(2)').textContent = new Date(updatedReserva.fecha_reserva).toLocaleDateString('es-ES');
  fila.querySelector('td:nth-child(3)').textContent = updatedReserva.estado_reserva;
  // Actualiza otras celdas según sea necesario
}
</script>
