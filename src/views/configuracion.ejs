<!-- src/views/configuracion.ejs -->
<link rel="shortcut icon"
  href="https://ajeetchaulagain.com/static/7cb4af597964b0911fe71cb2f8148d64/87351/express-js.png" type="image/x-icon" />
<%- include('./layouts/nav') %>
  <h1>Listado de Usuarios</h1>
  <button id="agregarUsuarioBtn">Agregar</button>

  <!-- Agregar Usuario Modal -->
  <div id="agregarUsuarioModal" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="cerrar">&times;</span>
      <h2>Agregar Usuario</h2>

      <form method="POST" action="/signup">
        <label for="rol">Rol:</label>
        <select id="rol" name="rol" required>
          <option value="" disabled selected>--Seleccione una opción--</option>
          <option value="cliente">Cliente</option>
          <option value="administrador">Administrador</option>
        </select>
        <input type="hidden" name="permisos">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombre" required>
        <label for="correo">Correo:</label>
        <input type="email" id="correo" name="correo" required>
        <label for="telefono">Teléfono:</label>
        <input type="number" id="telefono" name="telefono" required>
        <label for="documento">Documento:</label>
        <input type="number" id="documento" name="documento" required>
        <label for="contraseña">Contraseña:</label>
        <input type="password" id="contraseña" name="contraseña" required>


        <button type="submit">Guardar Usuario</button>
      </form>
    </div>
  </div>

  </div>
  <br>
  <table>
    <thead>
      <tr>
        <td>Id</td>
        <td>Rol</td>
        <td>Nombre</td>
        <td>Correo</td>
        <td>Documento</td>
        <td>Estado Usuario</td>
        <td>Contraseña</td>
        <td>Permisos</td>
        <td>Acción</td>
      </tr>
    </thead>
    <tbody>
      <% usuarios.forEach(usuario=> { %>
        <tr>
          <td>
            <%= usuario._id.toString() %>
          </td>
          <td>
            <%= usuario.rol %>
          </td>
          <td>
            <%= usuario.nombre %>
          </td>
          <td>
            <%= usuario.correo %>
          </td>
          <td>
            <%= usuario.documento %>
          </td>
          <td>
            <%= usuario.estado_usuario ? 'Activo' : 'Inactivo' %>
          </td>
          <td>
            <%= usuario.contraseña %>
          </td>
          <td>
            <% if (usuario.permisos && usuario.permisos.length> 0) { %>
              <% usuario.permisos.forEach(permiso=> { %>
                <div>
                  <%= permiso.nombre_permiso %> %>
                </div>
                <% }); %>
                  <% } else { %>
                    <div>No hay permisos asignados</div>
                    <% } %>
          </td>
          <td>
            <button class="editarUsuarioBtn" data-id="<%= usuario._id.toString() %>">Editar</button>
            <button class="eliminarUsuarioBtn" data-id="<%= usuario._id.toString() %>">Eliminar</button>
          </td>
        </tr>
        <% }); %>
    </tbody>
  </table>

  <script>
    // JavaScript para mostrar/ocultar el modal
    
    const agregarUsuarioBtn = document.getElementById('agregarUsuarioBtn');
    const agregarUsuarioModal = document.getElementById('agregarUsuarioModal');
    const cerrarModal = document.getElementById('cerrarModal');
    const eliminarUsuarioBtns = document.querySelectorAll('.eliminarUsuarioBtn');

    eliminarUsuarioBtns.forEach(btn => {
      btn.addEventListener('click', (event) => {
        const userId = event.currentTarget.dataset.id;
        console.log('userId:', userId);
    
        if (confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
          fetch(`/configuracion/${userId}`, {
            method: 'DELETE',
          })
            .then(response => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error(`Error en la solicitud: ${response.statusText}`);
              }
            })
            .then(data => {
              if (data.success) {
                alert('Usuario eliminado exitosamente');
                location.reload();
              } else {
                alert(`Error al eliminar el usuario: ${data.error}`);
              }
            })
            .catch(error => {
              console.error('Error al eliminar el usuario:', error);
              alert('Error al eliminar el usuario');
            });
        }
      });
    });
    
    agregarUsuarioBtn.addEventListener('click', () => {
      agregarUsuarioModal.style.display = 'block';
    });

    cerrarModal.addEventListener('click', () => {
      agregarUsuarioModal.style.display = 'none';
    });
  </script>